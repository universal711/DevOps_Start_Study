name: CI/CD - Final Version

on:
  push:
    branches: [ main ]

env:
  IMAGE_NAME: visit-counter
  K8S_NAMESPACE: visit-counter

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Validate application structure
      run: |
        echo "ğŸ” Validating project structure..."
        ls -la app/
        test -f app/package.json && echo "âœ… package.json exists"
        test -f app/server.js && echo "âœ… server.js exists"
        test -f Dockerfile && echo "âœ… Dockerfile exists"

    - name: Install dependencies
      run: |
        cd app
        npm ci
        echo "âœ… Dependencies installed"

    - name: Build Docker image
      run: |
        docker build -t ${{ env.IMAGE_NAME }}:test .
        echo "âœ… Docker image built"

    - name: Test Docker container
      run: |
        # Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€ Ğ½Ğ° ÑĞ²Ğ¾Ğ±Ğ¾Ğ´Ğ½Ğ¾Ğ¼ Ğ¿Ğ¾Ñ€Ñ‚Ñƒ
        docker run -d --name test-container -p 3080:3000 ${{ env.IMAGE_NAME }}:test
        sleep 5
        
        # Ğ¢ĞµÑÑ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ½Ğ° Ğ¿Ğ¾Ñ€Ñ‚Ñƒ 3080
        curl -f http://localhost:3080/health || (docker logs test-container && exit 1)
        curl -f http://localhost:3080/ || (docker logs test-container && exit 1)
        curl -f http://localhost:3080/stats || (docker logs test-container && exit 1)
        
        docker stop test-container
        docker rm test-container
        echo "âœ… Docker container tested successfully on port 3080"

  deploy-to-kubernetes:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Minikube and kubectl
      run: |
        echo "ğŸš€ Setting up Kubernetes environment..."
        
        # Install kubectl
        curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
        chmod +x kubectl
        sudo mv kubectl /usr/local/bin/
        
        # Install Minikube
        curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
        chmod +x minikube-linux-amd64
        sudo mv minikube-linux-amd64 /usr/local/bin/minikube

    - name: Start Minikube cluster
      run: |
        minikube start --driver=docker --memory=4096 --cpus=2 --force
        echo "âœ… Minikube started"
        minikube status
        eval $(minikube docker-env)

    - name: Build image in Minikube environment
      run: |
        docker build -t ${{ env.IMAGE_NAME }}:latest .
        echo "âœ… Image built in Minikube"

    - name: Deploy application
      run: |
        # Create namespace
        kubectl create namespace ${{ env.K8S_NAMESPACE }} || true
        
        # Apply Kubernetes manifests
        kubectl apply -f kubernetes/namespace.yaml
        kubectl apply -f kubernetes/configmap.yaml
        kubectl apply -f kubernetes/secret.yaml
        kubectl apply -f kubernetes/service-account.yaml
        
        # Update deployment to use latest image and single replica
        sed -i 's|visit-counter:1.0|visit-counter:latest|g' kubernetes/deployment.yaml
        sed -i 's/replicas: 3/replicas: 1/g' kubernetes/deployment.yaml
        kubectl apply -f kubernetes/deployment.yaml

        kubectl apply -f kubernetes/service.yaml
        echo "âœ… Kubernetes resources applied"

    - name: Wait for deployment
      run: |
        echo "â³ Waiting for deployment to be ready..."
        
        # Wait for pod to be created and running
        TIMEOUT=180
        INTERVAL=5
        ATTEMPTS=$((TIMEOUT/INTERVAL))
        
        for i in $(seq 1 $ATTEMPTS); do
          POD_STATUS=$(kubectl get pods -n ${{ env.K8S_NAMESPACE }} -l app=visit-counter -o jsonpath='{.items[0].status.phase}' 2>/dev/null || echo "No pod")
          echo "Attempt $i/$ATTEMPTS - Pod status: $POD_STATUS"
          
          if [ "$POD_STATUS" = "Running" ]; then
            echo "âœ… Pod is running!"
            break
          fi
          
          if [ "$POD_STATUS" = "Failed" ] || [ "$POD_STATUS" = "Error" ]; then
            echo "âŒ Pod failed. Showing details:"
            kubectl describe pods -n ${{ env.K8S_NAMESPACE }} -l app=visit-counter
            kubectl logs -n ${{ env.K8S_NAMESPACE }} -l app=visit-counter --tail=20
            exit 1
          fi
          
          if [ $i -eq $ATTEMPTS ]; then
            echo "âŒ Timeout waiting for pod. Current status: $POD_STATUS"
            echo "=== Debugging info ==="
            kubectl get all -n ${{ env.K8S_NAMESPACE }}
            kubectl describe pods -n ${{ env.K8S_NAMESPACE }} -l app=visit-counter 2>/dev/null || echo "No pods to describe"
            exit 1
          fi
          
          sleep $INTERVAL
        done
        
        # Show final status
        echo "=== Final Status ==="
        kubectl get all -n ${{ env.K8S_NAMESPACE }}

    - name: Test deployed application
      run: |
        echo "ğŸ§ª Testing deployed application..."
        
        # Port forward to a different port to avoid conflicts
        kubectl port-forward -n ${{ env.K8S_NAMESPACE }} service/visit-counter-service 3081:80 &
        PORT_FORWARD_PID=$!
        sleep 10
        
        # Test with retries
        for i in {1..10}; do
          echo "Test attempt $i/10"
          if curl -f http://localhost:3081/health 2>/dev/null; then
            echo "âœ… Health check passed!"
            if curl -f http://localhost:3081/ 2>/dev/null; then
              echo "âœ… Main endpoint passed!"
              TEST_RESULT="success"
              break
            fi
          fi
          echo "Waiting for application to be ready..."
          sleep 5
        done
        
        # Cleanup
        kill $PORT_FORWARD_PID 2>/dev/null || true
        
        if [ "$TEST_RESULT" != "success" ]; then
          echo "âŒ Application tests failed"
          echo "=== Pod logs ==="
          kubectl logs -n ${{ env.K8S_NAMESPACE }} -l app=visit-counter --tail=50
          exit 1
        fi

    - name: Success
      run: |
        echo "ğŸ‰ ğŸ‰ ğŸ‰ SUCCESS! ğŸ‰ ğŸ‰ ğŸ‰"
        echo "âœ… Application built, tested, and deployed to Kubernetes!"
        echo "ğŸ“Š Final status:"
        kubectl get all -n ${{ env.K8S_NAMESPACE }}
        echo "ğŸŒ Minikube service info:"
        minikube service list -n ${{ env.K8S_NAMESPACE }}
